<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OBS Framework: TestCasePUSDataReportingPacket_1.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>TestCasePUSDataReportingPacket_1.cpp</h1><pre class="fragment"><div>00001 <span class="comment">//</span>
00002 <span class="comment">// Copyright 2004 P&amp;P Software GmbH - All Rights Reserved</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// TestCasePUSDataReportingPacket_1.cpp</span>
00005 <span class="comment">//</span>
00006 <span class="comment">// Version      1.0</span>
00007 <span class="comment">// Date         04.10.02</span>
00008 <span class="comment">// Author       A. Pasetti (P&amp;P Software)</span>
00009 
00010 <span class="preprocessor">#include "../GeneralInclude/CompilerSwitches.h"</span>
00011 <span class="preprocessor">#include "../GeneralInclude/ClassId.h"</span>
00012 <span class="preprocessor">#include "../GeneralInclude/BasicTypes.h"</span>
00013 <span class="preprocessor">#include "../GeneralInclude/Constants.h"</span>
00014 <span class="preprocessor">#include "../Telemetry/DC_PUSDataReportingPacket.h"</span>
00015 <span class="preprocessor">#include "../Data/DC_SampleFullDataPool.h"</span>
00016 <span class="preprocessor">#include "../Utilities/TestCaseWithEvtCheck.h"</span>
00017 <span class="preprocessor">#include "TestCasePUSDataReportingPacket_1.h"</span>
00018 
00019 <span class="preprocessor">#include &lt;math.h&gt;</span>
00020 <span class="preprocessor">#include &lt;float.h&gt;</span>
00021 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 
<a name="l00024"></a><a class="code" href="classTestCasePUSDataReportingPacket__1.html#a0">00024</a> <a class="code" href="classTestCasePUSDataReportingPacket__1.html#a0">TestCasePUSDataReportingPacket_1::TestCasePUSDataReportingPacket_1</a>(<span class="keywordtype">void</span>) :
00025         <a class="code" href="classTestCaseWithEvtCheck.html">TestCaseWithEvtCheck</a>(ID_PUSDATAREPORTINGPACKET*10+1,"<a class="code" href="classTestCasePUSDataReportingPacket__1.html">TestCasePUSDataReportingPacket_1</a>") {
00026                 <span class="keywordflow">return</span>;
00027 }
00028 
<a name="l00029"></a><a class="code" href="classTestCasePUSDataReportingPacket__1.html#a1">00029</a> <span class="keywordtype">void</span> <a class="code" href="classTestCasePUSDataReportingPacket__1.html#a1">TestCasePUSDataReportingPacket_1::runTestCase</a>(<span class="keywordtype">void</span>) {
00030 
00031    <a class="code" href="classDC__SampleFullDataPool.html">DC_SampleFullDataPool</a>* pDP = <span class="keyword">new</span> <a class="code" href="classDC__SampleFullDataPool.html">DC_SampleFullDataPool</a>();
00032    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nEvt = <a class="code" href="classTestCaseWithEvtCheck.html#b0">getNumberOfEvents</a>();
00033    <a class="code" href="classDC__PUSDataReportingPacket.html">DC_PUSDataReportingPacket</a>* pTMP = <span class="keyword">new</span> <a class="code" href="classDC__PUSDataReportingPacket.html">DC_PUSDataReportingPacket</a>();
00034 
00035    <span class="comment">// Configure and load the data pool</span>
00036    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a1">setObsClock</a>(DC_PUSDataReportingPacket::getObsClock());
00037    <a class="code" href="classDataPool.html">DataPool</a>* pOldDP = <a class="code" href="classCC__RootObject.html#e8">CC_RootObject::getDataPool</a>();
00038    CC_RootObject::setDataPool(pDP);
00039 
00040    <span class="comment">// Define the PUS packet</span>
00041    <a class="code" href="BasicTypes_8h.html#a21">TD_SID</a> sid = 12;
00042    <a class="code" href="BasicTypes_8h.html#a23">TD_PUSCollectionInterval</a> collectionInterval = 3;
00043    <a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a> NPAR1 = 2;
00044    <a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a> par1 = 1;
00045    <a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a> val1 = 11;
00046    <a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a> par2 = 2;
00047    <a class="code" href="BasicTypes_8h.html#a17">TD_Float</a> val2 = 12.0;
00048 
00049    <span class="comment">// Construct the packet</span>
00050    <a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a> <span class="keyword">const</span> defPacketSize = 30;
00051    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> packet[defPacketSize];
00052    <a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a> offset = 0;
00053    memcpy(packet+offset,&amp;sid,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00054    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00055    memcpy(packet+offset,&amp;collectionInterval,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a23">TD_PUSCollectionInterval</a>));
00056    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a23">TD_PUSCollectionInterval</a>);
00057    memcpy(packet+offset,&amp;NPAR1,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a>));
00058    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a>);
00059    memcpy(packet+offset,&amp;par1,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>));
00060    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>);
00061    memcpy(packet+offset,&amp;par2,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>));
00062    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>);
00063 
00064    assert(offset&lt;defPacketSize);
00065 
00066    <span class="comment">// Check the correctness of the class identifier</span>
00067    <span class="keywordflow">if</span> ( (pTMP-&gt;<a class="code" href="classCC__RootObject.html#a3">getClassId</a>() != ID_PUSDATAREPORTINGPACKET) )
00068    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong class identifier for the FSM class"</span>);
00069         <span class="keywordflow">return</span>;
00070    }
00071 
00072    <span class="comment">// Check configuration status</span>
00073    <span class="keywordflow">if</span> ( pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a22">isObjectConfigured</a>() )
00074    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong configuration status at initialization"</span>);
00075         <span class="keywordflow">return</span>;
00076    }
00077 
00078    <span class="comment">// Set maximum number of FA arrays and check correctness</span>
00079    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a18">setMaxNumberFA</a>(2);
00080    <span class="keywordflow">if</span> ( pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a19">getMaxNumberFA</a>()!=2 )
00081    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of FA arrays"</span>);
00082         <span class="keywordflow">return</span>;
00083    }
00084 
00085    <span class="comment">// Set maximum size of the packet definition buffer and check correctness</span>
00086    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a16">setDefinitionBufferSize</a>(defPacketSize);
00087    <span class="keywordflow">if</span> ( pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a17">getDefinitionBufferSize</a>()!=defPacketSize )
00088    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong definition buffer size"</span>);
00089         <span class="keywordflow">return</span>;
00090    }
00091 
00092    <span class="comment">// Set maximum size of the packet value buffer and check correctness</span>
00093    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> valBufferSize = 30;
00094    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a20">setValueBufferSize</a>(valBufferSize);
00095    <span class="keywordflow">if</span> ( pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a21">getValueBufferSize</a>()!=valBufferSize )
00096    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong value buffer size"</span>);
00097         <span class="keywordflow">return</span>;
00098    }
00099 
00100    <span class="comment">// Load the packet subtype and time tag check configuration status</span>
00101    pTMP-&gt;<a class="code" href="classPUSTelemetryPacket.html#a7">setTimeTag</a>(0);
00102    pTMP-&gt;<a class="code" href="classPUSTelemetryPacket.html#a2">setSubType</a>(<a class="code" href="Constants_8h.html#a70">PUS_ST_DATA_REP_PAR_HK_REP</a>);
00103    <span class="keywordflow">if</span> ( !pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a22">isObjectConfigured</a>() )
00104    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong configuration status"</span>);
00105         <span class="keywordflow">return</span>;
00106    }
00107 
00108    <span class="comment">// Check that packet is disabled</span>
00109    <span class="keywordflow">if</span> ( (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a2">isEnabled</a>() == <a class="code" href="Constants_8h.html#a3">ENABLED</a>) )
00110    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong enable status"</span>);
00111         <span class="keywordflow">return</span>;
00112    }
00113 
00114    <span class="comment">// Load the packet definition</span>
00115    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> i=0; i&lt;offset; i++)
00116         pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a7">setDefinitionBuffer</a>(i,packet[i]);
00117 
00118    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a9">getDefinitionBufferLength</a>()!=offset)
00119    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong definition buffer length"</span>);
00120         <span class="keywordflow">return</span>;
00121    }
00122 
00123    <span class="comment">// Send three update requests and check that there are no data to be acquired</span>
00124    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00125    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00126    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00127         <span class="keywordflow">return</span>;
00128    }
00129    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00130    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00131    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00132         <span class="keywordflow">return</span>;
00133    }
00134    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00135    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00136    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00137         <span class="keywordflow">return</span>;
00138    }
00139 
00140    <span class="comment">// Enable the component and check correctness</span>
00141    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a1">setEnabled</a>(<a class="code" href="Constants_8h.html#a3">ENABLED</a>);
00142    <span class="keywordflow">if</span> ( (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a2">isEnabled</a>() == <a class="code" href="Constants_8h.html#a2">DISABLED</a>) )
00143    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong enable status"</span>);
00144         <span class="keywordflow">return</span>;
00145    }
00146 
00147    <span class="comment">// Send two update requests and check that there are no data to be acquired</span>
00148    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00149    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00150    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00151         <span class="keywordflow">return</span>;
00152    }
00153    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00154    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00155    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00156         <span class="keywordflow">return</span>;
00157    }
00158 
00159    <span class="comment">// Update the values of the data pool items</span>
00160    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par1,val1);
00161    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par2,val2);
00162 
00163    <span class="comment">// Send an update request and check data acquisition service</span>
00164    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00165    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n1, n2, n3;
00166    n1 = <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00167    n2 = (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00168    n3 = <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)+<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>);
00169    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expNumberOfBytes = n1+n2+n3;
00170    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=expNumberOfBytes)
00171    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00172         <span class="keywordflow">return</span>;
00173    }
00174 
00175    <span class="comment">// Collect the packet data and check their values</span>
00176    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* valBuffer = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[valBufferSize];
00177    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>(); i++)
00178        valBuffer[i] = pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a13">getUnsignedByte</a>(i);
00179 
00180    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> valOffset = 0;
00181    <a class="code" href="BasicTypes_8h.html#a21">TD_SID</a> sidTemp = 0;
00182    <a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a> intTemp = 0;
00183    <a class="code" href="BasicTypes_8h.html#a17">TD_Float</a> flTemp = 0;
00184 
00185    memcpy(&amp;sidTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00186    <span class="keywordflow">if</span> ( sidTemp != sid )
00187    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong sid field"</span>);
00188         <span class="keywordflow">return</span>;
00189    }
00190    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00191 
00192    <span class="keywordflow">if</span> ( <a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?valBuffer[valOffset]!=0:<span class="keyword">false</span> )
00193    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong mode field"</span>);
00194         <span class="keywordflow">return</span>;
00195    }
00196    valOffset += (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00197 
00198    memcpy(&amp;intTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>));
00199    <span class="keywordflow">if</span> ( intTemp != (<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>)val1 )
00200    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 1 field"</span>);
00201         <span class="keywordflow">return</span>;
00202    }
00203    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>);
00204 
00205    memcpy(&amp;flTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>));
00206    <span class="keywordflow">if</span> ( fabs((<span class="keywordtype">float</span>)(flTemp - (<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)val2)) &gt; FLT_EPSILON )
00207    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 2 field"</span>);
00208         <span class="keywordflow">return</span>;
00209    }
00210    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>);
00211 
00212    assert(valOffset&lt;valBufferSize);
00213 
00214    <span class="comment">// Check that the fast version of the data acquisition service is implemented</span>
00215    <span class="keywordflow">if</span> ( !pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a15">isFastAcquisitionImplemented</a>() )
00216    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Fast data acquisition service should be implemented"</span>);
00217         <span class="keywordflow">return</span>;
00218    }
00219 
00220    <span class="comment">// Collect the packet data using the fast version of the data acquisition </span>
00221    <span class="comment">// service and check their values</span>
00222    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* temp = pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a14">getStartAddress</a>();
00223    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>(); i++)
00224        valBuffer[i] = temp[i];
00225 
00226    valOffset = 0;
00227    memcpy(&amp;sidTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00228    <span class="keywordflow">if</span> ( sidTemp != sid )
00229    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong sid field"</span>);
00230         <span class="keywordflow">return</span>;
00231    }
00232    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00233 
00234    <span class="keywordflow">if</span> ( <a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?valBuffer[valOffset]!=0:<span class="keyword">false</span> )
00235    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong mode field"</span>);
00236         <span class="keywordflow">return</span>;
00237    }
00238    valOffset += (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00239 
00240    memcpy(&amp;intTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>));
00241    <span class="keywordflow">if</span> ( intTemp != (<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>)val1 )
00242    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 1 field"</span>);
00243         <span class="keywordflow">return</span>;
00244    }
00245    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>);
00246    memcpy(&amp;flTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>));
00247    <span class="keywordflow">if</span> ( fabs((<span class="keywordtype">float</span>)(flTemp - (<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)val2)) &gt; FLT_EPSILON )
00248    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 2 field"</span>);
00249         <span class="keywordflow">return</span>;
00250    }
00251    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>);
00252 
00253    assert(valOffset&lt;valBufferSize);
00254 
00255    <span class="comment">// Update the values in the data pool</span>
00256    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par1,(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>)(2*val1));
00257    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par2,(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)(2*val2));
00258 
00259    <span class="comment">// Send three update requests and check data acquisition service</span>
00260    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00261    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00262    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00263    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>(); i++)
00264        valBuffer[i] = pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a13">getUnsignedByte</a>(i);
00265 
00266    valOffset = 0;
00267    memcpy(&amp;sidTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00268    <span class="keywordflow">if</span> ( sidTemp != sid )
00269    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong sid field"</span>);
00270         <span class="keywordflow">return</span>;
00271    }
00272    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00273 
00274    <span class="keywordflow">if</span> ( <a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?valBuffer[valOffset]!=0:<span class="keyword">false</span> )
00275    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong mode field"</span>);
00276         <span class="keywordflow">return</span>;
00277    }
00278    valOffset += (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00279 
00280    memcpy(&amp;intTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>));
00281    <span class="keywordflow">if</span> ( intTemp != (<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>)2*val1 )
00282    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 1 field"</span>);
00283         <span class="keywordflow">return</span>;
00284    }
00285    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>);
00286 
00287    memcpy(&amp;flTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>));
00288    <span class="keywordflow">if</span> ( fabs((<span class="keywordtype">float</span>)(flTemp - (<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)2*val2)) &gt; FLT_EPSILON )
00289    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 2 field"</span>);
00290         <span class="keywordflow">return</span>;
00291    }
00292    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>);
00293 
00294    assert(valOffset&lt;valBufferSize);
00295 
00296    <span class="comment">// Update the values in the data pool</span>
00297    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par1,(<a class="code" href="BasicTypes_8h.html#a18">TD_Integer</a>)(3*val1));
00298    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par2,(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)(3*val2));
00299 
00300    <span class="comment">// Define a new PUS packet</span>
00301    sid = 13;
00302    collectionInterval = 2;
00303    NPAR1 = 1;
00304 
00305    <span class="comment">// Construct the packet</span>
00306    offset = 0;
00307    memcpy(packet+offset,&amp;sid,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00308    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00309    memcpy(packet+offset,&amp;collectionInterval,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a23">TD_PUSCollectionInterval</a>));
00310    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a23">TD_PUSCollectionInterval</a>);
00311    memcpy(packet+offset,&amp;NPAR1,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a>));
00312    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a24">TD_PUSNumberOfParameters</a>);
00313    memcpy(packet+offset,&amp;par2,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>));
00314    offset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a16">TD_DataPoolId</a>);
00315 
00316    assert(offset&lt;defPacketSize);
00317 
00318    <span class="comment">// Load the packet definition</span>
00319    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> i=0; i&lt;offset; i++)
00320         pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a7">setDefinitionBuffer</a>(i,packet[i]);
00321 
00322    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a9">getDefinitionBufferLength</a>()!=offset)
00323    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong definition buffer length"</span>);
00324         <span class="keywordflow">return</span>;
00325    }
00326 
00327    <span class="comment">// Send an update request and check that there are no data to be acquired</span>
00328    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00329    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=0)
00330    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00331         <span class="keywordflow">return</span>;
00332    }
00333 
00334    <span class="comment">// Update the values of the data pool items</span>
00335    pDP-&gt;<a class="code" href="classDC__SampleFullDataPool.html#a3">setValue</a>(par2,4*val2);
00336 
00337    <span class="comment">// Send an update request and check data acquisition service</span>
00338    pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a10">update</a>();
00339    n1 = <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00340    n2 = (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00341    n3 = <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>);
00342    expNumberOfBytes = n1+n2+n3;
00343    <span class="keywordflow">if</span> (pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>()!=expNumberOfBytes)
00344    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong number of bytes"</span>);
00345         <span class="keywordflow">return</span>;
00346    }
00347 
00348    <span class="comment">// Collect the packet data and check their values</span>
00349    valBuffer = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[valBufferSize];
00350    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a12">getNumberOfBytes</a>(); i++)
00351        valBuffer[i] = pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a13">getUnsignedByte</a>(i);
00352 
00353    valOffset = 0;
00354    memcpy(&amp;sidTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>));
00355    <span class="keywordflow">if</span> ( sidTemp != sid )
00356    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong sid field"</span>);
00357         <span class="keywordflow">return</span>;
00358    }
00359    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a21">TD_SID</a>);
00360 
00361    <span class="keywordflow">if</span> ( <a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?valBuffer[valOffset]!=0:<span class="keyword">false</span> )
00362    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong mode field"</span>);
00363         <span class="keywordflow">return</span>;
00364    }
00365 
00366    valOffset += (<a class="code" href="Constants_8h.html#a34">PUS_DATA_REP_MODE</a>?1:0);
00367 
00368    memcpy(&amp;flTemp,valBuffer+valOffset,<span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>));
00369    <span class="keywordflow">if</span> ( fabs((<span class="keywordtype">float</span>)(flTemp - (<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>)4*val2)) &gt; FLT_EPSILON )
00370    {    setTestResult(<a class="code" href="TestConstants_8h.html#a1">TEST_FAILURE</a>,<span class="stringliteral">"Wrong parameter 2 field"</span>);
00371         <span class="keywordflow">return</span>;
00372    }
00373    valOffset += <span class="keyword">sizeof</span>(<a class="code" href="BasicTypes_8h.html#a17">TD_Float</a>);
00374 
00375    assert(valOffset&lt;valBufferSize);
00376 
00377    <span class="comment">// Simulate an attempt to load a larger-than-legal definition packet</span>
00378    <span class="keywordflow">if</span> (<a class="code" href="classTestCase.html#b1">isNonNominalCheckAllowed</a>()) {
00379         pTMP-&gt;<a class="code" href="classDC__PUSDataReportingPacket.html#a7">setDefinitionBuffer</a>(defPacketSize,0); <span class="comment">// the maximum value of the first par is (defPacketSize-1)</span>
00380         <span class="keywordflow">if</span> ( !verifyLatestEvent(nEvt+1,EVT_ILLEGAL_PUS_REP_PACKET) )
00381             <span class="keywordflow">return</span>;
00382         nEvt = nEvt+1;         
00383    }
00384 
00385    <span class="comment">// Restore the original data pool</span>
00386    CC_RootObject::setDataPool(pOldDP);
00387 
00388    setTestResult(<a class="code" href="TestConstants_8h.html#a0">TEST_SUCCESS</a>,<span class="stringliteral">"Test Successful"</span>);
00389    <span class="keywordflow">return</span>;
00390 }
</div></pre><center>
<b>Copyright 2003 <a href="http://www.pnp-software.com/" target="_parent">P&P Software GmbH</a> - All Rights Reserved</b>
</center>
